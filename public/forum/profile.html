<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/headerForum.css">
    <link rel="stylesheet" href="../css/modal.css">
    <link rel="stylesheet" href="../css/profile.css">
    <link rel="stylesheet" href="../css/footer.css">
    <script src="../js/sessao.js"></script>
    <title>Document</title>
</head>

<body onload="atualizarDadosUsuario()">
    <header class="header_container">
        <section class="section_header container">
            <div class="img_container">
                <img src="../assets/img/voleibol_png_branca.png" alt="">
            </div>
            <div class="perfil_container">
                <div class="foto_perfil">
                    <img src="../assets/img/user_profiel_image.png" alt="">
                </div>
                <span onclick="dropDownMenuToggle()" class="menu_toggle">
                    <span id="user_name"></span>
                    <i class="fa-solid fa-sort-down"></i>
                    <div id="dropDownMenu" class="dropdow_menu">
                        <span onclick="navegation('profile.html')"><i class="fa-solid fa-user"></i> Perfi</span>
                        <span onclick="limparSessao()"><i class="fa-solid fa-right-from-bracket"></i> Sair</span>
                    </div>
                </span>
            </div>
        </section>
    </header>
    <section class="nav_section">
        <div class="nav_content container">
            <nav class=nav_menu>
                <span onclick="navegation('home.html')" class="item_menu">Feed</span>
                <span class="item_menu">Notícias</span>
            </nav>
            <div class="pesquisa_container">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" placeholder="Pesquisar...">
            </div>
        </div>
    </section>

    <!-- PROFILE CONTENT -->
    <main>
        <div class="container">
            <div class="profile_container">
                <div class="profile_info">
                    <div class="profile_foto">
                        <img src="../assets/img/user_profiel_image.png" alt="">
                    </div>
                    <div class="profile_form">
                        <label>Nome:</label>
                        <input id="input_nome" type="text" value="" disabled>
                        <label>Email:</label>
                        <input id="input_email" type="text" value="" disabled>
                        <span id="error_email" class="msg_error">Insira um email válido</span>

                        <label>Senha:</label>
                        <input id="input_password" type="password" value="" onkeyup="validarSenha()" disabled>
                        <span id="error_senha" class="msg_error">Senha Inválida</span>
                        <ul id="validation_list" class="validationList">
                            <li id="validation1">Deve conter 10 caracteres</li>
                            <li id="validation2">Deve conter um caracter especial (@ ou #)</li>
                            <li id="validation3">Deve conter um número</li>
                        </ul>

                        <label>Confirmar Senha:</label>
                        <input id="input_confirm_password" type="password" disabled>
                        <span id="error_conf_senha" class="msg_error">As senhas devem ser iguais</span>

                        <div id="divBtnForm" class="div_btn_form">

                            <button onclick="changeBtnFormEdit()" class="btn_config">Editar Perfil <i
                                    class="fa-solid fa-pencil"></i></button>
                        </div>
                    </div>
                </div>
                <div id="grid1">
                    <div class="feedHeader">
                        <h2>Publicações</h2>
                        <span onclick="navegation('dashboard.html')">ver estatisticas</span>
                    </div>
                    <div id="feed">

                    </div>
                </div>
            </div>
        </div>
        </div>
    </main>

    <!-- MODAL EDIT -->
    <div id="modal_post" class="modal_container">
        <div class="modal_content">
            <div onclick="toggleModalEdit()" class="header_modal"><i class="fa-solid fa-x"></i></div>
            <div class="form_post">
                <label>Assunto:</label>
                <input id="input_assunto" type="text" name="assunto">
                <label>Descricao:</label>
                <textarea id="input_descricao" type="" name="descricao" rows="10" cols="50"> </textarea>
                <button onclick="editar()" class="btn_insert_post">SALVAR ALTERAÇÕES</button>
            </div>
        </div>
    </div>

    <!-- MODAL DELETE -->
    <div id="modal_delete" class="modal_container">
        <div class="modal_content">
            <div onclick="toggleModalDelete()" class="header_modal"><i class="fa-solid fa-x"></i></div>
            <div class="form_post">
                <h2 class="title_confirm">Deseja realmente apagar esta postagem?</h2>
                <div class="btn_container_confirm">
                    <button onclick="toggleModalDelete()" class="btn_confirm cancelar">CANCELAR</button>
                    <button onclick="deletar()" class="btn_confirm deletar">DELETAR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- footer -->
    <footer class="footer_container scroll_content">
        <div class="top_footer">
            <div class="img_container_footer ">
                <img src="../assets/img/voleibol_png_branca.png" alt="">
            </div>
            <ul class="list_footer">
                <li class="title_list">Navegação</li>
                <li>História</li>
                <li>Características</li>
                <li>Sobre mim</li>
            </ul>
            <ul class="list_footer">
                <li class="title_list">Contato</li>
                <li>(+55) 0000-0000</li>
                <li>(+55) 3691-0000</li>
                <li>nome.sobrenome@gmail.com</li>
            </ul>
            <div class="list_icon">
                <p class="title_list">Redes Sociais</p>
                <div class="flex_icon">
                    <i class="fa-brands fa-instagram"></i>
                    <i class="fa-brands fa-whatsapp"></i>
                    <i class="fa-brands fa-facebook"></i>
                </div>
            </div>
        </div>
        <div class="bottom_footer">
            <p>©2024 - Vôlei como estilo de vida</p>
        </div>
    </footer>
</body>

</html>

<script src="https://kit.fontawesome.com/d94da5d75d.js" crossorigin="anonymous"></script>

<script>
    var idUsuario = sessionStorage.ID_USUARIO;
    user_name.innerHTML = sessionStorage.getItem('NOME_USUARIO')

    let btnEditFormOpen = true;
    function changeBtnFormEdit() {
        if (btnEditFormOpen) {
            validation_list.style.display = 'flex'
            input_nome.disabled = false;
            input_email.disabled = false;
            input_password.disabled = false;
            input_confirm_password.disabled = false;
    
            divBtnForm.innerHTML = `
            <button onclick="atualizarCadastroUsuario()" class="btn_config confirm">Salvar Alterações</i></button>
            <button onclick="changeBtnFormEdit()" class="btn_config">Cancelar</button>
            `

        } else {
            validation_list.style.display = 'none'
            error_email.style.display = 'none';
            error_conf_senha.style.display = 'none'
            error_senha.style.display = 'none'
            input_nome.disabled = true;
            input_email.disabled = true;
            input_password.disabled = true;
            input_confirm_password.disabled = true;
            divBtnForm.innerHTML = `
            <button onclick="changeBtnFormEdit()" class="btn_config">Editar Perfil <i class="fa-solid fa-pencil"></i></button>
            `
        }
        btnEditFormOpen = !btnEditFormOpen;
    }

    function atualizarCadastroUsuario() {
        const name = input_nome.value;
        const email = input_email.value;
        const password = input_password.value;
        const confirmPassword = input_confirm_password.value;
        let msgError = '';
        let wrongColor = 'rgb(240, 81, 81)'
        let correctColor = 'rgb(43, 207, 98)'
        error_email.style.display = 'none';
        error_conf_senha.style.display = 'none'
        error_senha.style.display = 'none'

        let validationIsCompleted = true;

        if (name == '' || email == '' || password == '' || confirmPassword == '') {
            // msgError = 'Preencha todos os campos'
            // alertMsg(msgError, wrongColor);
            alert("Preencha todos os campos")
        }


        if (email.indexOf('@') < 0 || email.indexOf('.com') < 0) {
            error_email.style.display = 'block';
            validationIsCompleted = false;
        }


        if (confirmPassword != password) {
            error_conf_senha.style.display = 'block'
            validationIsCompleted = false;
        }

        if (validarSenha() <= 3 && validarSenha() > 0) {
            error_senha.style.display = 'block'
            validationIsCompleted = false;
        }

        if (validationIsCompleted == false) {
            console.log("TudoValidado")
        } else {
            fetch(`/usuarios/editar/${idUsuario}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    nome: name,
                    email: email,
                    senha: password
                })
            }).then(function (resposta) {

                if (resposta.ok) {
                    sessionStorage.setItem('NOME_USUARIO', name)
                    window.alert("Dados do usuário atualizados com sucesso: " + sessionStorage.getItem("EMAIL_USUARIO") + "!");
                    window.location = "profile.html"
                } else if (resposta.status == 404) {
                    window.alert("Deu 404!");
                } else {
                    throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        }

    }

    function changeValidation(content, colorValidation) {
        content.className = '';
        content.classList.add(colorValidation)
        if (colorValidation == 'wrong') return 1;
        else return 0;
    }

    function validarSenha() {
        const password = input_password.value;
        const primeiraValidation = document.querySelector("#validation1")
        const segundaValidation = document.querySelector("#validation2")
        const terceiraValidation = document.querySelector("#validation3")

        const hasTenCaracters = password.length >= 10 ? 'correct' : 'wrong';
        const hasSpecial = password.indexOf('@') > 0 || password.indexOf('#') > 0 ? 'correct' : 'wrong';

        let hasNumber = 'wrong';
        for (let i = 0; i <= 9; i++) {
            let numberConvertido = i.toString()
            if (password.indexOf(numberConvertido) >= 0) {
                hasNumber = 'correct'
            }

        }

        let faliedPasswordValidation = 0
        faliedPasswordValidation += changeValidation(primeiraValidation, hasTenCaracters)
        faliedPasswordValidation += changeValidation(segundaValidation, hasSpecial)
        faliedPasswordValidation += changeValidation(terceiraValidation, hasNumber)

        return faliedPasswordValidation
    }

    let dadosUsuario = '';
    let postagensUsuarios = '';

    function atualizarDadosUsuario() {

        fetch(`/usuarios/listar/${idUsuario}`, { cache: 'no-store' })
            .then(function (response) {
                if (response.ok) {

                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        dadosUsuario = resposta.dataUser;
                        postagensUsuarios = resposta.postagens;
                        console.log(dadosUsuario)
                        console.log(postagensUsuarios)

                        input_nome.value = dadosUsuario.nome
                        input_email.value = dadosUsuario.email
                        // input_senha.value = dadosUsuario.senha
                        if (postagensUsuarios.length <= 0) {
                            feed.innerHTML = `<h3 style="text-align: center">Nenhuma postagem publicada!</h3>`

                        }
                        postagensUsuarios.map(postagem => {
                            feed.innerHTML += `
                            <div class="post_item">
                            <div class="post_section">
                                <div onclick="irParaPost(${postagem.idPostagem})" class="post_content">
                                    <div class="post_info">
                                        <p>${postagem.nome}
                                            <i class="fa-solid fa-circle"></i>
                                            <span class="dataTime_post">
                                                ${formatarTempoPostagem(postagem.dataHora)}
                                            </span>
                                        </p>
                                        <h2>${postagem.assunto}</h2>
                                    </div>
                                    <div class="post_status">
                                        <span class="status_item">
                                            <i class="fa-solid fa-message msg"></i>
                                            ${postagem.qtdComentarios} Comentários
                                        </span>
                                        <span class="status_item">
                                            <i class="fa-solid fa-heart like"></i>
                                            ${postagem.qtdCurtidas} Curtidas
                                        </span>
                                        <span class="status_item">
                                            <i class="fa-solid fa-eye view"></i>
                                            ${postagem.qtdVisualizacoes} Visualizações
                                        </span>
                                    </div>
                                </div>
                                <div class="btn_post_edit">
                                    <button onclick="toggleModalEdit(${postagem.idPostagem}, '${postagem.assunto}', '${postagem.descricao}')" class="btn_config">Editar</button>
                                    <button onclick="toggleModalDelete(${postagem.idPostagem})" class="btn_config">Deletar</button>
                                </div>
                            </div>

                        </div>
                            `
                        })

                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function editar() {
        fetch(`/postagens/editar/${sessionStorage.getItem("ID_POSTAGEM_EDITANDO")}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                assunto: input_assunto.value,
                descricao: input_descricao.value
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                window.alert("Post atualizado com sucesso pelo usuario de email: " + sessionStorage.getItem("EMAIL_USUARIO") + "!");
                window.location = "profile.html"
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    function deletar() {
        console.log("Criar função de apagar post escolhido - ID");
        fetch(`/postagens/deletar`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idUsuario: idUsuario,
                idPostagem: sessionStorage.getItem("ID_POSTAGEM_DELETANDO")
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                window.alert("Post deletado com sucesso pelo usuario de email: " + sessionStorage.getItem("EMAIL_USUARIO") + "!");
                window.location = "profile.html"
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    function formatarTempoPostagem(dataHora) {
        let dataPostagem = '';
        const datetimeString = dataHora;
        let startDate = new Date(datetimeString);
        let currentDate = new Date();
        let differenceInMilliseconds = currentDate - startDate;

        let seconds = Math.floor(differenceInMilliseconds / 1000);
        let minutes = Math.floor(seconds / 60);
        let hours = Math.floor(minutes / 60);
        let days = Math.floor(hours / 24);

        seconds %= 60;
        minutes %= 60;
        hours %= 24;

        if (days > 0) {
            dataPostagem = `${days} d`;
        } else if (hours > 0) {
            dataPostagem = `${hours} h`
        } else if (minutes > 0) {
            dataPostagem = `${minutes} min`
        } else {
            dataPostagem = `${seconds} s`
        }

        return dataPostagem;

    }

    let dropdowMenuOpen = false;
    function dropDownMenuToggle() {
        if (dropdowMenuOpen) {
            dropDownMenu.style.display = 'none'

        } else {
            dropDownMenu.style.display = 'flex'
        }
        dropdowMenuOpen = !dropdowMenuOpen;
    }



    let modalOpen = false;
    function toggleModalEdit(idPostagem, assunto, descricao) {
        input_assunto.value = '';
        input_descricao.value = '';
        sessionStorage.setItem('ID_POSTAGEM_EDITANDO', idPostagem)

        if (modalOpen) {
            modal_post.style.display = 'none'
            document.body.style.overflow = 'auto';

        } else {
            document.body.style.overflow = 'hidden';
            modal_post.style.display = 'flex'
            input_assunto.value = assunto;
            input_descricao.value = descricao;
        }
        modalOpen = !modalOpen;
    }

    function toggleModalDelete(idPostagem) {
        sessionStorage.setItem('ID_POSTAGEM_DELETANDO', idPostagem)
        if (modalOpen) {
            modal_delete.style.display = 'none'
            document.body.style.overflow = 'auto';

        } else {
            document.body.style.overflow = 'hidden';
            modal_delete.style.display = 'flex'

        }
        modalOpen = !modalOpen;
    }

    function irParaPost(id) {
        window.location = `post.html?id=${id}`
    }

    function navegation(url) {
        window.location = url
    }
</script>