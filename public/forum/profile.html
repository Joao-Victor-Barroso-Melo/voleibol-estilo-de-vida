<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/headerForum.css">
    <link rel="stylesheet" href="../css/modal.css">
    <link rel="stylesheet" href="../css/profile.css">
    <link rel="stylesheet" href="../css/footer.css">
    <link rel="stylesheet" href="../css/alertMsg.css">
    <link rel="stylesheet" href="../css/loader.css">
    <script src="../js/sessao.js"></script>
    <title>Document</title>
</head>

<body onload="atualizarDadosUsuario()">
    <span id="alert_msg"></span>
    <header class="header_container">
        <section class="section_header container">
            <div class="img_container">
                <img onclick="navegation('home.html')" src="../assets/img/voleibol_png_branca.png" alt="">
            </div>
            <div class="perfil_container">
                <div id="foto_perfil_header" class="foto_perfil">
                </div>
                <span onclick="dropDownMenuToggle()" class="menu_toggle">
                    <span id="user_name"></span>
                    <i class="fa-solid fa-sort-down"></i>
                    <div id="dropDownMenu" class="dropdow_menu">
                        <span onclick="navegation('profile.html')"><i class="fa-solid fa-user"></i> Perfi</span>
                        <span onclick="limparSessao()"><i class="fa-solid fa-right-from-bracket"></i> Sair</span>
                    </div>
                </span>
            </div>
        </section>
    </header>
    <section class="nav_section">
        <div class="nav_content container">
            <nav class=nav_menu>
                <span onclick="navegation('home.html')" class="item_menu"><i class="fa-solid fa-comment-dots"></i>
                    Fórum</span>
                <span onclick="navegation('news.html')" class="item_menu"><i class="fa-solid fa-newspaper"></i>
                    Notícias</span>
            </nav>
        </div>
    </section>

    <!-- PROFILE CONTENT -->
    <main>
        <div class="container">
            <div class="profile_container">
                <div class="profile_info">
                    <div id="foto_perfil_lateral" class="profile_foto">

                    </div>
                    <div class="profile_form">
                        <input name="foto" id="foto" type="file" disabled />
                        <label>Nome:</label>
                        <input id="input_nome" type="text" value="" disabled>
                        <label>Email:</label>
                        <input id="input_email" type="text" value="" disabled>
                        <span id="error_email" class="msg_error">Insira um email válido</span>

                        <label>Senha:</label>
                        <span class="container_senha">
                            <i onclick="showPassword(eye_icon, input_password)" id="eye_icon"
                                class="fa-solid fa-eye"></i>
                            <input id="input_password" type="password" value="" onkeyup="validarSenha()" disabled>
                        </span>
                        <span id="error_senha" class="msg_error">Senha Inválida</span>
                        <ul id="validation_list" class="validationList">
                            <li id="validation1">Deve conter 10 caracteres</li>
                            <li id="validation2">Deve conter um caracter especial (@ ou #)</li>
                            <li id="validation3">Deve conter um número</li>
                        </ul>

                        <label>Confirmar Senha:</label>
                        <span class="container_senha">
                            <i onclick="showPassword(eye_icon_confirm, input_confirm_password)" id="eye_icon_confirm"
                                class="fa-solid fa-eye"></i>
                            <input id="input_confirm_password" type="password" disabled>
                        </span>
                        <span id="error_conf_senha" class="msg_error">As senhas devem ser iguais</span>

                        <div id="divBtnForm" class="div_btn_form">

                            <button onclick="changeBtnFormEdit()" class="btn_config">Editar Perfil <i
                                    class="fa-solid fa-pencil"></i></button>
                        </div>
                    </div>
                </div>
                <div id="grid1">
                    <div class="feedHeader">
                        <h2>Publicações</h2>
                        <span onclick="navegation('dashboard.html')"><i class="fa-solid fa-chart-simple"></i> ver
                            estatísticas</span>
                    </div>
                    <div id="feed">

                    </div>
                </div>
            </div>
        </div>
        </div>
    </main>

    <!-- MODAL EDIT -->
    <div id="modal_post" class="modal_container">
        <div class="modal_content">
            <div onclick="toggleModalEdit()" class="header_modal"><i class="fa-solid fa-x"></i></div>
            <div class="form_post">
                <label>Assunto:</label>
                <input id="input_assunto" type="text" name="assunto">
                <label>Descricao:</label>
                <textarea id="input_descricao" type="" name="descricao" rows="10" cols="50"> </textarea>
                <div id="btn_content">
                    <button onclick="editar()" class="btn_insert_post">SALVAR ALTERAÇÕES</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DELETE -->
    <div id="modal_delete" class="modal_container">
        <div class="modal_content">
            <div onclick="toggleModalDelete()" class="header_modal"><i class="fa-solid fa-x"></i></div>
            <div class="form_post">
                <h2 class="title_confirm">Deseja realmente apagar esta postagem?</h2>
                <div id="btn_delete_content" class="btn_container_confirm">
                    <button onclick="toggleModalDelete()" class="btn_confirm cancelar">CANCELAR</button>
                    <button onclick="deletar()" class="btn_confirm deletar">DELETAR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- footer -->
    <footer class="footer_container scroll_content">
        <div class="top_footer">
            <div class="img_container_footer ">
                <img src="../assets/img/voleibol_png_branca.png" alt="">
            </div>
            <ul class="list_footer">
                <li class="title_list">Navegação</li>
                <li><a href="home.html" class="link_footer">Home</a></li>
                <li><a href="news.html" class="link_footer">Notícias</a></li>
                <li><a onclick="navegation('profile.html')" class="link_footer">Perfil</a></li>
            </ul>
            <ul class="list_footer">
                <li class="title_list">Contato</li>
                <li>+55 (88) 99215-1831</li>
                <li>joao.melo@sptech.school</li>
            </ul>
            <div class="list_icon">
                <p class="title_list">Social</p>
                <div class="flex_icon">
                    <a href="https://www.instagram.com/_jaov_/" target="_blank">
                        <i class="fa-brands fa-instagram"></i></a>
                    <a href="https://www.linkedin.com/in/joão-victor-632a1021a/" target="_blank">
                        <i class="fa-brands fa-linkedin"></i></a>
                    <a href="https://github.com/Joao-Victor-Barroso-Melo" target="_blank">
                        <i class="fa-brands fa-github"></i></a>
                </div>
            </div>
        </div>
        <div class="bottom_footer">
            <p>©2024 - Vôlei como estilo de vida</p>
        </div>
    </footer>
</body>

</html>

<script src="https://kit.fontawesome.com/d94da5d75d.js" crossorigin="anonymous"></script>
<script src="../js/alertMsg.js"></script>

<script>
    var idUsuario = sessionStorage.ID_USUARIO;
    user_name.innerHTML = sessionStorage.getItem('NOME_USUARIO')

    let btnEditFormOpen = true;
    function changeBtnFormEdit() {
        if (btnEditFormOpen) {
            validation_list.style.display = 'flex'
            input_nome.disabled = false;
            input_email.disabled = false;
            input_password.disabled = false;
            input_confirm_password.disabled = false;
            foto.disabled = false;

            divBtnForm.innerHTML = `
            <button onclick="atualizarCadastroUsuario()" class="btn_config confirm">Salvar Alterações</i></button>
            <button onclick="changeBtnFormEdit()" class="btn_config">Cancelar</button>
            `

        } else {
            validation_list.style.display = 'none'
            error_email.style.display = 'none';
            error_conf_senha.style.display = 'none'
            error_senha.style.display = 'none'
            input_nome.disabled = true;
            input_email.disabled = true;
            input_password.disabled = true;
            input_confirm_password.disabled = true;
            foto.disabled = true;
            divBtnForm.innerHTML = `
            <button onclick="changeBtnFormEdit()" class="btn_config">Editar Perfil <i class="fa-solid fa-pencil"></i></button>
            `
        }
        btnEditFormOpen = !btnEditFormOpen;
    }

    function atualizarCadastroUsuario() {
        const name = input_nome.value;
        const email = input_email.value;
        const password = input_password.value;
        const confirmPassword = input_confirm_password.value;

        error_email.style.display = 'none';
        error_conf_senha.style.display = 'none'
        error_senha.style.display = 'none'

        const formData = new FormData();
        formData.append('foto', foto.files[0])
        formData.append('nome', name)
        formData.append('senha', password)
        formData.append('email', email)

        let validationIsCompleted = true;

        if (name == '' || email == '' || password == '' || confirmPassword == '') {
            alertMsg('Preencha todos os campos', 'wrongColor');
        }


        if (email.indexOf('@') < 0 || email.indexOf('.com') < 0) {
            error_email.style.display = 'block';
            validationIsCompleted = false;
        }


        if (confirmPassword != password) {
            error_conf_senha.style.display = 'block'
            validationIsCompleted = false;
        }

        if (validarSenha() <= 3 && validarSenha() > 0) {
            error_senha.style.display = 'block'
            validationIsCompleted = false;
        }

        if (validationIsCompleted == false) {
            console.log("TudoValidado")
        } else {
            divBtnForm.innerHTML = `<span class="loader"></span>`
            fetch(`/usuarios/editar/${idUsuario}`, {
                method: "PUT",
                body: formData
            }).then(function (resposta) {

                if (resposta.ok) {
                    sessionStorage.setItem('NOME_USUARIO', name)
                    alertMsg('Dados do usuário atualizados com sucesso', 'corrctColor');
                    setTimeout(() => {
                        window.location = "profile.html"
                    }, 1000)
                } else if (resposta.status == 404) {
                    window.alert("Deu 404!");

                    divBtnForm.innerHTML = `
                    <button onclick="atualizarCadastroUsuario()" class="btn_config confirm">Salvar Alterações</i></button>
                    <button onclick="changeBtnFormEdit()" class="btn_config">Cancelar</button>`

                } else {
                    throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        }

    }

    function changeValidation(content, colorValidation) {
        content.className = '';
        content.classList.add(colorValidation)
        if (colorValidation == 'wrong') return 1;
        else return 0;
    }

    function validarSenha() {
        const password = input_password.value;
        const primeiraValidation = document.querySelector("#validation1")
        const segundaValidation = document.querySelector("#validation2")
        const terceiraValidation = document.querySelector("#validation3")

        const hasTenCaracters = password.length >= 10 ? 'correct' : 'wrong';
        const hasSpecial = password.indexOf('@') >= 0 || password.indexOf('#') >= 0 ? 'correct' : 'wrong';

        let hasNumber = 'wrong';
        for (let i = 0; i <= 9; i++) {
            let numberConvertido = i.toString()
            if (password.indexOf(numberConvertido) >= 0) {
                hasNumber = 'correct'
            }

        }

        let faliedPasswordValidation = 0
        faliedPasswordValidation += changeValidation(primeiraValidation, hasTenCaracters)
        faliedPasswordValidation += changeValidation(segundaValidation, hasSpecial)
        faliedPasswordValidation += changeValidation(terceiraValidation, hasNumber)

        return faliedPasswordValidation
    }

    let dadosUsuario = '';
    let postagensUsuarios = '';

    function atualizarDadosUsuario() {

        fetch(`/usuarios/listar/${idUsuario}`, { cache: 'no-store' })
            .then(function (response) {
                if (response.ok) {

                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        dadosUsuario = resposta.dataUser;
                        postagensUsuarios = resposta.postagens;
                        console.log(dadosUsuario)
                        console.log(postagensUsuarios)

                        sessionStorage.setItem('FOTO_PERFIL', dadosUsuario.fotoPerfil)
                        var fotoPerfil = sessionStorage.FOTO_PERFIL

                        if (fotoPerfil != '') {
                            foto_perfil_header.style.backgroundImage = `url(../assets/profiles_img/${fotoPerfil})`
                        } else {
                            foto_perfil_header.style.backgroundImage = `url(../assets/img/user_profiel_image.png)`

                        }

                        input_nome.value = dadosUsuario.nome
                        input_email.value = dadosUsuario.email
                        input_password.value = dadosUsuario.senha
                        input_confirm_password.value = dadosUsuario.senha
                        // input_senha.value = dadosUsuario.senha
                        if (postagensUsuarios.length <= 0) {
                            feed.innerHTML = `<h3 style="text-align: center">Nenhuma postagem publicada!</h3>`
                        }

                        // ALTERA FOTO LATERAL DA PAGINA DO PERFIL
                        if (dadosUsuario.fotoPerfil == '') {
                            foto_perfil_lateral.style.backgroundImage = 'url(../assets/img/user_profiel_image.png)'
                        } else {
                            foto_perfil_lateral.style.backgroundImage = `url(../assets/profiles_img/${dadosUsuario.fotoPerfil})`
                        }

                        postagensUsuarios.map((postagem, index) => {
                            const editBody = {
                                id: postagem.idPostagem,
                                assunto: `${postagem.assunto}`,
                                descricao: `${postagem.descricao}`
                            }


                            feed.innerHTML += `
                            <div class="post_item">
                            <div class="post_section">
                                <div onclick="irParaPost(${postagem.idPostagem})" class="post_content">
                                    <div class="post_info">
                                        <p>${postagem.nome}
                                            <i class="fa-solid fa-circle"></i>
                                            <span class="dataTime_post">
                                                ${formatarTempoPostagem(postagem.dataHora)}
                                            </span>
                                        </p>
                                        <h2>${postagem.assunto}</h2>
                                    </div>
                                    <div class="post_status">
                                        <span class="status_item">
                                            <i class="fa-solid fa-message msg"></i>
                                            ${postagem.qtdComentarios} Comentários
                                        </span>
                                        <span class="status_item">
                                            <i class="fa-solid fa-heart like"></i>
                                            ${postagem.qtdCurtidas} Curtidas
                                        </span>
                                        <span class="status_item">
                                            <i class="fa-solid fa-eye view"></i>
                                            ${postagem.qtdVisualizacoes} Visualizações
                                        </span>
                                    </div>
                                </div>
                                <div class="btn_post_edit">
                                    <button onclick="toggleModalEdit(${index})" class="btn_config">Editar</button>
                                    <button onclick="toggleModalDelete(${postagem.idPostagem})" class="btn_config">Deletar</button>
                                </div>
                            </div>

                        </div>
                            `
                        })

                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function editar() {
        btn_content.innerHTML = `<span class="loader"></span>`
        fetch(`/postagens/editar/${sessionStorage.getItem("ID_POSTAGEM_EDITANDO")}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                assunto: input_assunto.value,
                descricao: input_descricao.value
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                alertMsg('Post atualizado com sucesso', 'correctColor')
                setTimeout(() => {
                    window.location = "profile.html"
                }, 1000)
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
                btn_content.innerHTML = `<button onclick="editar()" class="btn_insert_post">SALVAR ALTERAÇÕES</button>`

            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    function deletar() {
        btn_delete_content.innerHTML = `<span class="loader"></span>`
        fetch(`/postagens/deletar`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idUsuario: idUsuario,
                idPostagem: sessionStorage.getItem("ID_POSTAGEM_DELETANDO")
            })
        }).then(function (resposta) {

            if (resposta.ok) {

                alertMsg('Post deletado com sucesso', 'correctColor')
                setTimeout(() => {
                    window.location = "profile.html"
                }, 1000)
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
                btn_delete_content.innerHTML =
                    `<button onclick="toggleModalDelete()" class="btn_confirm cancelar">CANCELAR</button>
                    <button onclick="deletar()" class="btn_confirm deletar">DELETAR</button>`

            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    function formatarTempoPostagem(dataHora) {
        let dataPostagem = '';
        const datetimeString = dataHora;
        let startDate = new Date(datetimeString);
        let currentDate = new Date();
        let differenceInMilliseconds = currentDate - startDate;

        let seconds = Math.floor(differenceInMilliseconds / 1000);
        let minutes = Math.floor(seconds / 60);
        let hours = Math.floor(minutes / 60);
        let days = Math.floor(hours / 24);

        seconds %= 60;
        minutes %= 60;
        hours %= 24;

        if (days > 0) {
            dataPostagem = `${days} d`;
        } else if (hours > 0) {
            dataPostagem = `${hours} h`
        } else if (minutes > 0) {
            dataPostagem = `${minutes} min`
        } else {
            dataPostagem = `${seconds} s`
        }

        return dataPostagem;

    }

    let dropdowMenuOpen = false;
    function dropDownMenuToggle() {
        if (dropdowMenuOpen) {
            dropDownMenu.style.display = 'none'

        } else {
            dropDownMenu.style.display = 'flex'
        }
        dropdowMenuOpen = !dropdowMenuOpen;
    }

    function showPassword(idIcon, idInput) {
        if (idInput.type == 'password') {
            idIcon.classList.remove('fa-eye')
            idIcon.classList.add('fa-eye-slash')
            idInput.type = 'text'
        } else if (idInput.type == 'text') {
            idInput.type = 'password'
            idIcon.classList.remove('fa-eye-slash')
            idIcon.classList.add('fa-eye')
        }
    }

    let modalOpen = false;
    function toggleModalEdit(index) {
        console.log('entrou')
        const postagemEdit = postagensUsuarios[index]
        input_assunto.value = '';
        input_descricao.value = '';

        if (modalOpen) {
            modal_post.style.display = 'none'
            document.body.style.overflow = 'auto';

        } else {
            sessionStorage.setItem('ID_POSTAGEM_EDITANDO', postagemEdit.idPostagem)
            document.body.style.overflow = 'hidden';
            modal_post.style.display = 'flex'
            input_assunto.value = postagemEdit.assunto;
            input_descricao.value = postagemEdit.descricao;
        }
        modalOpen = !modalOpen;
    }

    function toggleModalDelete(idPostagem) {
        sessionStorage.setItem('ID_POSTAGEM_DELETANDO', idPostagem)
        if (modalOpen) {
            modal_delete.style.display = 'none'
            document.body.style.overflow = 'auto';

        } else {
            document.body.style.overflow = 'hidden';
            modal_delete.style.display = 'flex'

        }
        modalOpen = !modalOpen;
    }

    function irParaPost(idPostagem) {
        fetch(`/visualizacoes/adicionar`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idUsuario: idUsuario,
                idPostagem: idPostagem
            })
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
                window.location = `post.html?id=${idPostagem}`

            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);

        });
    }

    function navegation(url) {
        window.location = url
    }
</script>